---
title: "Final Project: Citi Bikes Sample"
author: "Robert Berini"
format: html
editor: visual
execute: 
  warning: false
  message: false
---

## Introduction

The Citi Bike program is a bike-sharing system in New York City that allows users to rent bicycles for short trips around the city. The program has become increasingly popular since its launch in 2013, with millions of rides taken each year. In this project, we will analyze Citi Bike trip data for 2018 to gain insights into usage patterns, popular routes, and user profiles.

The primary operational goal is to optimize bike distribution across stations to meet demand. Bike turnover time is a critical metric for this purpose, as it indicates how frequently bikes are rented and returned at each station. By analyzing trip duration, start and end locations, and user demographics, we can identify high-demand stations and times of day, allowing for better allocation and re-balancing of bikes and improved service for users. Monthly operational reports can be found at <https://citibikenyc.com/system-data/operating-reports>.

In 2018, Citi Bike offered two main rider types: **Subscribers** and **Customers**. Subscribers paid an annual membership fee of \$169 for unlimited rides up to 45 minutes each. The overage fee for subscribers was \$2.50 for each additional 15 minutes. Customers paid \$3 for a single ride of 30 minutes or less, or \$12 for a day pass including unlimited 30-minute rides within 24 hours. The overage fee for customers was \$4 for each additional 15 minutes. Understanding the differences in usage patterns between these two groups can help inform pricing strategies and service improvements.

### Data Source

The data for this analysis is sourced from the Citi Bike system's public data repository (<https://citibikenyc.com/system-data>), which provides monthly trip data in CSV format. The dataset includes information such as trip duration, start and end stations, user type (subscriber or customer), and timestamps for each trip.

### Data Dictionary

-   `tripduration`: Duration of the trip in seconds (numeric)
-   `tripduration_min`: Duration of the trip in minutes (numeric, calculated from tripduration)
-   `starttime`: Timestamp for when the trip started (datetime)
-   `stoptime`: Timestamp for when the trip ended (datetime)
-   `month`: Month the trip took place (ordered factor: Jan-Dec)
-   `day_of_week`: Day of the week the trip started (ordered factor: Mon-Sun)
-   `weekday_weekend`: Whether the trip occurred on a weekday or weekend (factor)
-   `hour_of_day`: Hour of day when the trip started, 0-23 (integer)
-   `time_of_day`: Time period classification (ordered factor: Morning, Late Morning, Afternoon, Evening, Night)
-   `start_station_id`: Unique identifier for the starting station (character)
-   `start_station_name`: Name of the starting station (character)
-   `start_station_latitude`: Latitude coordinate of the starting station (numeric)
-   `start_station_longitude`: Longitude coordinate of the starting station (numeric)
-   `end_station_id`: Unique identifier for the ending station (character)
-   `end_station_name`: Name of the ending station (character)
-   `end_station_latitude`: Latitude coordinate of the ending station (numeric)
-   `end_station_longitude`: Longitude coordinate of the ending station (numeric)
-   `round_trip`: Whether the trip started and ended at the same station (logical: TRUE/FALSE)
-   `bikeid`: Unique identifier for the bike used (character)
-   `usertype`: Type of user (factor: Subscriber or Customer)
-   `birth_year`: Self-reported birth year of the user (numeric)
-   `approx_age`: Approximate age of the user in 2018 (numeric, calculated as 2018 - birth_year)
-   `gender`: Self-reported gender of the user (factor: Male, Female, Unknown)

## Data Loading and Preparation

Load required packages

```{r}
library(conflicted)
library(tidyverse)
library(janitor)
library(urbnthemes)
library(broom)
library(skimr)
library(psych)
library(infer)
library(leaflet)
library(knitr)
library(kableExtra)

conflicts_prefer(
  dplyr::filter,
  urbnthemes::scale_fill_discrete,
  urbnthemes::scale_colour_discrete,
  urbnthemes::scale_fill_ordinal,
  janitor::chisq.test
)

options(
  scipen = 999,
  pillar.sigfig = 10
  )

set_urbn_defaults(style = "print")
```

Load the full transformed Citi Bike 2018 data (for reference)

```{r}
citibike_2018 <- readRDS("data/combined/citibike_2018_transformed.rds")
```

Load the Citi Bike 2018 data sample

```{r}
citibike_sample_2018 <-
  readRDS("data/sample/citibike_2018_sample_1000.rds")

glimpse(citibike_sample_2018)
```

## Exploratory data analysis

### Summary statistics

Produce summary statistics on sample data

```{r}
citibike_sample_2018 |>
  summary()
```

Conduct enhanced skim summary

```{r}
citibike_sample_2018 |>
  skim()
```

Consider key numerical variables by user type

```{r}
citibike_sample_2018 |>
  select(c(tripduration_min, approx_age)) |>
  describeBy(group = citibike_sample_2018$usertype)
```

### Inference for trip duration mean

#### Trip duration analysis

Conduct univariate analysis of trip duration

```{r}
citibike_sample_2018 |>
  select(tripduration_min) |>
  describe()
```

Consider distribution of trip duration

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(
    title = "Distribution of Trip Duration",
    x = "Trip Duration (minutes)",
    y = "Density"
  ) +
  remove_axis(axis = "y") +
  remove_ticks()
```

Zoom in on distribution of trip duration up to 60 minutes

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(
    title = "Distribution of Trip Duration",
    x = "Trip Duration (minutes)",
    y = "Density"
  ) +
  xlim(0, 60) +
  remove_axis(axis = "y") +
  remove_ticks()
```

#### Bootstrap confidence interval for mean trip duration

Check mean trip duration in sample

```{r}
set.seed(557)

citibike_sample_2018 |>
  slice_sample(n = nrow(citibike_sample_2018), replace = TRUE) |>
  pull(tripduration_min) |>
  mean(na.rm = TRUE)
```

Generate a single bootstrap sample, calculate mean trip duration, and plot statistic

```{r}
set.seed(557)

boot_dist_1 <- citibike_sample_2018 |>
  specify(response = tripduration_min) |>
  generate(reps = 1, type = "bootstrap") |>
  calculate(stat = "mean")

print(boot_dist_1)

boot_dist_1 |>
  ggplot(aes(x = stat)) +
  geom_dotplot(binwidth = 0.1, fill = "#1696d2", stroke = 0) +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )

ggsave(
  filename = "images/citibike_boot_1.png",
  width = 6,
  height = 4,
  units = "in",
  dpi = 600
)
```

Generate ten bootstrap samples, calculate mean trip duration, and plot statistic

```{r}
set.seed(557)

boot_dist_10 <- citibike_sample_2018 |>
  specify(response = tripduration_min) |>
  generate(reps = 10, type = "bootstrap") |>
  calculate(stat = "mean")

print(boot_dist_10)

boot_dist_10 |>
  ggplot(aes(x = stat)) +
  geom_dotplot(binwidth = 0.1, fill = "#1696d2", stroke = 0) +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )

ggsave(
  filename = "images/citibike_boot_10.png",
  width = 6,
  height = 4,
  units = "in",
  dpi = 600
)
```

Generate 1000 bootstrap samples, calculate mean trip duration, and plot statistic

```{r}
set.seed(557)

boot_dist_1000 <- citibike_sample_2018 |>
  specify(response = tripduration_min) |>
  generate(reps = 1000, type = "bootstrap") |>
  calculate(stat = "mean")

boot_dist_1000 |>
  ggplot(aes(x = stat)) +
  geom_dotplot(binwidth = 0.1, dotsize = .45, fill = "#1696d2", stroke = 0) +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )

ggsave(
  filename = "images/citibike_boot_1000.png",
  width = 6,
  height = 4,
  units = "in",
  dpi = 600
)
```

Calculate 95% bootstrap confidence interval for mean trip duration and visualize

```{r}
boot_ci <- boot_dist_1000 |>
  get_confidence_interval(level = 0.95, type = "percentile")

print(boot_ci)

boot_dist_1000 |>
  visualize(bins = 100, fill = "#1696d2", stroke = 0) +
  shade_confidence_interval(endpoints = boot_ci, fill = "#fdbf11", color = "#fdbf11") +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )

ggsave(
  filename = "images/citibike_boot_ci.png",
  width = 6,
  height = 4,
  units = "in",
  dpi = 600
)
```

#### Mathematical confidence interval for mean trip duration

Perform t-test to calculate 95% confidence interval mathematically

```{r}
citibike_sample_2018 |>
  select(tripduration_min) |>
  t.test(conf.level = 0.95) |>
  tidy()
```

#### Comparison of bootstrap and mathematical confidence intervals

Compare population mean, bootstrap mean and CI, and t-test mean and CI

```{r}
pop_mean <- mean(citibike_2018$tripduration_min, na.rm = TRUE)

boot_mean <- mean(boot_dist_1000$stat)

t_result <- citibike_sample_2018 |>
  select(tripduration_min) |>
  t.test(conf.level = 0.95) |>
  tidy()

ci_table <-
  tibble(
    Method = c("Population (True)", "Bootstrap", "T-test"),
    Mean = c(pop_mean, boot_mean, t_result$estimate),
    Lower_CI = c(NA, boot_ci$lower_ci, t_result$conf.low),
    Upper_CI = c(NA, boot_ci$upper_ci, t_result$conf.high)
  ) |>
  kable(digits = 4) |>
  kable_styling(full_width = FALSE,
                font_size = 14,
                html_font = "Lato")

ci_table
```

```{r}
#| eval: false
#| echo: false

# this produces an error during rendering, so run separately to save image

save_kable(ci_table,
           file = "images/citibike_ci_table.png",
           zoom = 8,
           density = 600)
```

### Inference for difference in mean trip duration by weekday vs. weekend

#### Bivariate analysis

Consider distribution of trip duration by weekday vs. weekend zoomed to 60 minutes

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min, fill = weekday_weekend)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of Trip Durations by Week Part",
    x = "Trip Duration (minutes)",
    y = "Density",
    fill = "Week Part"
  ) +
  xlim(0, 60) +
  remove_axis(axis = "y") +
  remove_ticks()
```

Visualize trip duration by weekday vs. weekend with boxplots zoomed to 30 minutes

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = weekday_weekend, y = tripduration_min, fill = weekday_weekend)) +
  geom_boxplot(show.legend = FALSE, outlier.shape = NA) +
  stat_summary(
    fun = mean, 
    geom = "point", 
    shape = 23,
    size = 4, 
    fill = "#db2b27",
    color = "#000000",
    show.legend = FALSE
    ) +
  labs(
    title = "Trip Duration Distribution by Week Part",
    x = "",
    y = "Trip Duration (minutes)"
  ) +
  coord_flip(ylim = c(0, 30))
```

#### Randomization test: Mean trip duration on weekdays vs. weekends

Calculate observed difference in means

```{r}
obs_diff <- citibike_sample_2018 |>
  specify(tripduration_min ~ weekday_weekend) |>
  calculate(stat = "diff in means", order = c("Weekend", "Weekday"))

obs_diff
```

Generate null distribution through permutation

```{r}
set.seed(557)

null_distribution <- citibike_sample_2018 |>
  specify(tripduration_min ~ weekday_weekend) |>
  hypothesize(null = "independence") |>
  generate(reps = 1000, type = "permute") |>
  calculate(stat = "diff in means", order = c("Weekend", "Weekday"))
```

Visualize null distribution with observed statistic

```{r}
rdm_dmeans_weekpart <-
  null_distribution |>
  visualize() +
  shade_p_value(obs_stat = obs_diff$stat, direction = "two_sided") +
  labs(title = "Null Distribution of Mean Trip Duration Difference", x = "Difference in Mean Trip Duration (Weekend - Weekday)", y = "Frequency") +
  remove_axis(axis = "y") +
  remove_ticks()

rdm_dmeans_weekpart

ggsave(
  filename = "images/citibike_rdm_dmeans_weekpart.png",
  plot = rdm_dmeans_weekpart,
  width = 6,
  height = 4,
  units = "in",
  dpi = 600
)
```

Calculate p-value from randomization test

```{r}
null_distribution |>
  get_p_value(obs_stat = obs_diff$stat, direction = "two-sided")
```

#### Mathematical two-sample t-test: Mean trip duration on weekdays vs. weekends

Perform two-sample t-test

```{r}
citibike_sample_2018 |>
  mutate(weekday_weekend = fct_relevel(weekday_weekend, "Weekend", "Weekday")) |>
  (\(x) t.test(tripduration_min ~ weekday_weekend, data = x, var.equal = FALSE))() |>
  tidy()
```

#### Comparison of randomization test and t-test results

Compare population difference, randomization test result, and t-test result

```{r}
true_diff <- citibike_2018 |>
  group_by(weekday_weekend) |>
  summarize(mean_duration = mean(tripduration_min, na.rm = TRUE)) |>
  summarize(diff = diff(mean_duration)) |>
  pull(diff)

randomization_result <-
  null_distribution |>
  get_p_value(obs_stat = obs_diff$stat, direction = "two-sided") |>
  pull(p_value)

t_test_result <- citibike_sample_2018 |>
  mutate(weekday_weekend = fct_relevel(weekday_weekend, "Weekend", "Weekday")) |>
  (\(x) t.test(tripduration_min ~ weekday_weekend, data = x, var.equal = FALSE))() |>
  tidy()

rdm_dmeans_weekpart_table <-
  tibble(
    Method = c("Population (True)", "Randomization Test", "T-test"),
    Difference = c(true_diff, obs_diff$stat, t_test_result$estimate),
    P_Value = c(NA, randomization_result, t_test_result$p.value)
  ) |>
  kable(digits = 4) |>
  kable_styling(full_width = FALSE,
                font_size = 14,
                html_font = "Lato")

rdm_dmeans_weekpart_table
```

```{r}
#| eval: false
#| echo: false

save_kable(rdm_dmeans_weekpart_table,
           file = "images/citibike_rdm_dmeans_weekpart_table.png",
           zoom = 8,
           density = 600)
```

### Inference for difference in median trip duration by user type

#### Bivariate analysis

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min, fill = usertype)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of Trip Durations by User Type",
    x = "Trip Duration (minutes)",
    y = "Density",
    fill = "User Type"
  ) +
  xlim(0, 60) +
  remove_axis(axis = "y") +
  remove_ticks()
```

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = usertype, y = tripduration_min, fill = usertype)) +
  geom_boxplot(show.legend = FALSE, outlier.shape = NA) +
  stat_summary(
    fun = mean, 
    geom = "point", 
    shape = 23,
    size = 4, 
    fill = "#db2b27",
    color = "#000000",
    show.legend = FALSE
    ) +
  labs(
    title = "Trip Duration Distribution by Usertype",
    x = "",
    y = "Trip Duration (minutes)"
  ) +
  coord_flip(ylim = c(0, 60))
```

```{r}
citibike_sample_2018 |>
  group_by(usertype) |>
  summarize(median_duration = median(tripduration_min, na.rm = TRUE)) |>
  ggplot(aes(x = usertype, y = median_duration, fill = usertype)) +
  urbnthemes::geom_col(show.legend = FALSE) +
  labs(
    title = "Median Trip Duration by User Type",
    x = "",
    y = "Median Trip Duration (minutes)"
  ) +
  coord_flip()
```

#### Randomization test: Median trip duration by user type

Calculate observed difference in medians

```{r}
obs_diff_median <- citibike_sample_2018 |>
  specify(tripduration_min ~ usertype) |>
  calculate(stat = "diff in medians", order = c("Customer", "Subscriber"))

obs_diff_median
```

Generate null distribution through permutation

```{r}
set.seed(557)

null_distribution_median <- citibike_sample_2018 |>
  specify(tripduration_min ~ usertype) |>
  hypothesize(null = "independence") |>
  generate(reps = 1000, type = "permute") |>
  calculate(stat = "diff in medians", order = c("Customer", "Subscriber"))
```

Visualize null distribution with observed statistic

```{r}
null_distribution_median |>
  visualize() +
  shade_p_value(obs_stat = obs_diff_median, direction = "two-sided") +
  labs(
    title = "Null Distribution of Difference in Median Trip Duration",
    x = "Difference in Median Duration (minutes)",
    y = "Count"
  )
```

Calculate p-value from randomization test

```{r}
null_distribution_median |>
  get_p_value(obs_stat = obs_diff_median, direction = "two-sided")
```

#### Wilcoxon rank sum test: Median trip duration by user type

Perform Wilcoxon rank sum test

```{r}
wilcox.test(tripduration_min ~ usertype,
            data = citibike_sample_2018,
            exact = FALSE) |>
  tidy()
```

#### Comparison of randomization test and Wilcoxon test results

Compare population difference, randomization test result, and Wilcoxon test result

```{r}
true_diff_median <- citibike_2018 |>
  group_by(usertype) |>
  summarize(median_duration = median(tripduration_min, na.rm = TRUE)) |>
  summarize(diff = diff(median_duration)) |>
  pull(diff)

randomization_result_median <-
  null_distribution_median |>
  get_p_value(obs_stat = obs_diff_median, direction = "two-sided") |>
  pull(p_value)

wilcox_result <- wilcox.test(tripduration_min ~ usertype,
                              data = citibike_sample_2018,
                              exact = FALSE) |>
  tidy()

tibble(
  Method = c("Population (True)", "Randomization Test", "Wilcoxon Test"),
  Difference = c(
    true_diff_median,
    obs_diff_median$stat,
    obs_diff_median$stat  # Same observed difference
  ),
  P_Value = c(
    NA,
    randomization_result_median,
    wilcox_result$p.value
  )
)
```

### Additional exploratory analyses

Consider trip duration by time of day

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = time_of_day, y = tripduration_min, fill = time_of_day)) +
  geom_boxplot(show.legend = FALSE, outlier.shape = NA) +
  stat_summary(
    fun = mean, 
    geom = "point", 
    shape = 23,
    size = 3, 
    fill = "#db2b27",
    color = "#000000",
    show.legend = FALSE
    ) +
  labs(
    title = "Trip Duration Distribution by Time of Day",
    x = "",
    y = "Trip Duration (minutes)"
  ) +
  coord_flip(ylim = c(0, 30))
```

Conduct ANOVA to test for differences in mean trip duration by time of day

```{r}
aov(tripduration_min ~ time_of_day, data = citibike_sample_2018) |>
  tidy()
```

Consider trip volume by hour of day and user type

```{r}
citibike_sample_2018 |>
  count(hour_of_day, usertype) |>
  ggplot(aes(x = hour_of_day, y = n, color = usertype)) +
  geom_line(linewidth = 1) +
  geom_label(
    data = ~group_by(.x, usertype) |> filter(hour_of_day == max(hour_of_day)),
    aes(label = usertype),
    hjust = -0.1,
    size = 3,
    fontface = "bold",
    fill = "white",
    label.size = 0,
    label.padding = unit(0.15, "lines")
  ) +
  scale_x_continuous(
    breaks = seq(0, 24, by = 6),
    expand = expansion(mult = c(0.02, 0.15))
  ) +
  labs(title = "Trip Volume by Hour and User Type",
       x = "Hour of Day", y = "Number of Trips") +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")

ggsave(
  filename = "images/citibike_hour_user.png",
  width = 6,
  height = 4,
  units = "in",
  dpi = 300
)
```

Consider trip volume by day of week and user type

```{r}
citibike_sample_2018 |>
  count(day_of_week, usertype) |>
  ggplot(aes(x = day_of_week, y = n, color = usertype, group = usertype)) +
  geom_line(linewidth = 1) +
  geom_label(
    data = ~group_by(.x, usertype) |> filter(day_of_week == max(day_of_week)),
    aes(label = usertype),
    hjust = -0.1,
    size = 3,
    fontface = "bold",
    fill = "white",
    label.size = 0,
    label.padding = unit(0.15, "lines")
  ) +
  scale_x_discrete(
    expand = expansion(mult = c(0.02, 0.15))
  ) +
  labs(title = "Trip Volume by Day of Week and User Type",
       x = "Day of Week", y = "Number of Trips") +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")
```

Consider trip volume by month and user type

```{r}
citibike_sample_2018 |>
  count(month, usertype) |>
  ggplot(aes(x = month, y = n, color = usertype, group = usertype)) +
  geom_line(linewidth = 1) +
  geom_label(
    data = ~group_by(.x, usertype) |> filter(month == max(month)),
    aes(label = usertype),
    hjust = -0.1,
    size = 3,
    fontface = "bold",
    fill = "white",
    label.size = 0,
    label.padding = unit(0.15, "lines")
  ) +
  scale_x_discrete(
    expand = expansion(mult = c(0.02, 0.15))
  ) +
  labs(title = "Trip Volume by Month and User Type",
       x = "Month", y = "Number of Trips") +
  theme(legend.position = "none") +
  coord_cartesian(clip = "off")
```

Consider relationship between trip duration and user age

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = approx_age, y = tripduration_min)) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Trip Duration by Age",
    x = "Age (years)",
    y = "Trip Duration (minutes)"
  ) +
  scatter_grid()
```

Zoom in on relationship between trip duration and user age for trips up to 60 minutes

```{r}
citibike_sample_2018 |>
  filter(tripduration_min <= 60) |>
  ggplot(aes(x = approx_age, y = tripduration_min)) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Trip Duration by Age (trips â‰¤ 60 minutes)",
    x = "Age (years)",
    y = "Trip Duration (minutes)"
  ) +
  scatter_grid()
```

Calculate correlation between trip duration and user age

```{r}
cor.test(citibike_sample_2018$approx_age, 
         citibike_sample_2018$tripduration_min) |>
  tidy()
```

Consider user demographics by user type

```{r}
citibike_sample_2018 |>
  group_by(usertype, gender) |>
  summarize(
    n = n(),
    mean_age = mean(approx_age, na.rm = TRUE),
    median_age = median(approx_age, na.rm = TRUE),
    .groups = "drop"
  )
```

Conduct chi-square test for independence between user type and gender

```{r}
chisq.test(citibike_sample_2018$usertype, citibike_sample_2018$gender) |>
  tidy()
```

#### Popular start stations

Identify top 10 most popular start stations

```{r}
citibike_sample_2018 |>
  count(start_station_name, sort = TRUE) |>
  slice_head(n = 10) |>
  ggplot(aes(x = reorder(start_station_name, n), y = n)) +
  urbnthemes::geom_col() +
  coord_flip() +
  labs(title = "Top 10 Most Popular Start Stations",
       x = "", y = "Number of Trips")
```

Map of start stations sized by trip volume

```{r}
station_counts <- citibike_sample_2018 |>
  count(start_station_name, start_station_latitude, start_station_longitude) |>
  mutate(
    top_station = if_else(rank(desc(n)) <= 10, "Top 10", "Other"),
    color = if_else(top_station == "Top 10", "#0a4c6a", "#ca5800")
  ) |>
  arrange(top_station)

leaflet(station_counts) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addCircleMarkers(
    lng = ~start_station_longitude,
    lat = ~start_station_latitude,
    radius = ~(n^1.5) * 0.5,
    popup = ~paste0(start_station_name, "<br>Trips: ", n),
    fillOpacity = 0.7,
    color = ~color,
    fillColor = ~color,
    stroke = TRUE,
    weight = 1
  ) |>
  addLegend(
    position = "bottomright",
    colors = c("#0a4c6a", "#ca5800"),
    labels = c("Top 10", "Other"),
    title = "Start Station Volume"
  )
```

#### Popular end stations

Identify top 10 most popular end stations

```{r}
citibike_sample_2018 |>
  count(end_station_name, sort = TRUE) |>
  slice_head(n = 10) |>
  ggplot(aes(x = reorder(end_station_name, n), y = n)) +
  urbnthemes::geom_col() +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 10, by = 2.5)) +
  labs(title = "Top 10 Most Popular Destination Stations",
       x = "", y = "Number of Trips")
```

#### Map of popular start and end stations

Show combined map of top 10 start and end stations

```{r}
start_counts <- citibike_sample_2018 |>
  count(start_station_name, start_station_latitude, start_station_longitude) |>
  slice_max(n, n = 10) |>
  mutate(type = "Top Start")

end_counts <- citibike_sample_2018 |>
  count(end_station_name, end_station_latitude, end_station_longitude) |>
  rename(
    start_station_name = end_station_name,
    start_station_latitude = end_station_latitude,
    start_station_longitude = end_station_longitude
  ) |>
  slice_max(n, n = 10) |>
  mutate(type = "Top End")

station_counts <- bind_rows(end_counts, start_counts) |>
  mutate(
    color = if_else(type == "Top Start", "#0a4c6a", "#ca5800")
  )

leaflet(station_counts) |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addCircleMarkers(
    lng = ~start_station_longitude,
    lat = ~start_station_latitude,
    radius = ~sqrt(n) * 2.5,
    popup = ~paste0(start_station_name, "<br>", type, "<br>Trips: ", n),
    fillOpacity = 0.7,
    color = ~color,
    fillColor = ~color,
    stroke = TRUE,
    weight = 1
  ) |>
  addLegend(
    position = "bottomright",
    colors = c("#0a4c6a", "#ca5800"),
    labels = c("Top 10 Start Stations", "Top 10 End Stations"),
    title = "Station Type"
  )
```
