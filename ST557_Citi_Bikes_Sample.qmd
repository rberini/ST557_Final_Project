---
title: "Final Project: Citi Bikes Sample"
author: "Robert Berini"
format: html
editor: visual
execute: 
  warning: false
  message: false
---

## Introduction

The Citi Bike program is a bike-sharing system in New York City that allows users to rent bicycles for short trips around the city. The program has become increasingly popular since its launch in 2013, with millions of rides taken each year. In this project, we will analyze Citi Bike trip data for 2018 to gain insights into usage patterns, popular routes, and user profiles.

### Data Source

The data for this analysis is sourced from the Citi Bike system's public data repository, which provides monthly trip data in CSV format. The dataset includes information such as trip duration, start and end stations, user type (subscriber or customer), and timestamps for each trip.

### Data Dictionary

-   `starttime`: Timestamp for when the trip started (datetime)
-   `stoptime`: Timestamp for when the trip ended (datetime)
-   `tripduration`: Duration of the trip in seconds (numeric)
-   `tripduration_min`: Duration of the trip in minutes (numeric, calculated from tripduration)
-   `day_of_week`: Day of the week the trip started (ordered factor: Mon-Sun)
-   `weekday_weekend`: Whether the trip occurred on a weekday or weekend (factor)
-   `hour_of_day`: Hour of day when the trip started, 0-23 (integer)
-   `time_of_day`: Time period classification (ordered factor: Morning, Late Morning, Afternoon, Evening, Night)
-   `start_station_id`: Unique identifier for the starting station (character)
-   `start_station_name`: Name of the starting station (character)
-   `start_station_latitude`: Latitude coordinate of the starting station (numeric)
-   `start_station_longitude`: Longitude coordinate of the starting station (numeric)
-   `end_station_id`: Unique identifier for the ending station (character)
-   `end_station_name`: Name of the ending station (character)
-   `end_station_latitude`: Latitude coordinate of the ending station (numeric)
-   `end_station_longitude`: Longitude coordinate of the ending station (numeric)
-   `round_trip`: Whether the trip started and ended at the same station (logical: TRUE/FALSE)
-   `bikeid`: Unique identifier for the bike used (character)
-   `usertype`: Type of user (factor: Subscriber or Customer)
-   `birth_year`: Self-reported birth year of the user (numeric)
-   `approx_age`: Approximate age of the user in 2018 (numeric, calculated as 2018 - birth_year)
-   `gender`: Self-reported gender of the user (factor: Male, Female, Unknown)

## Data Loading and Preparation

Load required packages

```{r}
library(conflicted)
library(tidyverse)
library(janitor)
library(urbnthemes)
library(broom)
library(skimr)
library(psych)
library(infer)

conflicts_prefer(
  dplyr::filter,
  urbnthemes::scale_fill_discrete
)

options(
  scipen = 999,
  pillar.sigfig = 10
  )

set_urbn_defaults(style = "print")
```

Load the full transformed Citi Bike 2018 data (for reference)

```{r}
citibike_2018 <- readRDS("data/combined/citibike_2018_transformed.rds")
```

Load the Citi Bike 2018 data sample

```{r}
citibike_sample_2018 <-
  readRDS("data/sample/citibike_2018_sample_1000.rds")

glimpse(citibike_sample_2018)
```

## Exploratory data analysis

### Summary statistics

```{r}
citibike_sample_2018 |>
  summary()
```

```{r}
citibike_sample_2018 |>
  skim()
```

### Trip duration analysis

```{r}
citibike_sample_2018 |>
  select(tripduration_min) |>
  describe()
```

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(
    title = "Distribution of Trip Durations",
    x = "Trip Duration (minutes)",
    y = "Density"
  ) +
  theme_minimal()
```

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(
    title = "Distribution of Trip Durations",
    x = "Trip Duration (minutes)",
    y = "Density"
  ) +
  xlim(0, 60) +
  theme_minimal()
```

### Bootstrap confidence interval for mean trip duration

```{r}
set.seed(557)

citibike_sample_2018 |>
  slice_sample(n = nrow(citibike_sample_2018), replace = TRUE) |>
  pull(tripduration_min) |>
  mean(na.rm = TRUE)
```

```{r}
set.seed(557)

boot_dist_1 <- citibike_sample_2018 |>
  specify(response = tripduration_min) |>
  generate(reps = 1, type = "bootstrap") |>
  calculate(stat = "mean")

print(boot_dist_1)

boot_dist_1 |>
  ggplot(aes(x = stat)) +
  geom_dotplot(binwidth = 0.1, fill = "#1696d2", stroke = 0) +
  theme_minimal() +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )
```

```{r}
set.seed(557)

boot_dist_10 <- citibike_sample_2018 |>
  specify(response = tripduration_min) |>
  generate(reps = 10, type = "bootstrap") |>
  calculate(stat = "mean")

print(boot_dist_10)

boot_dist_10 |>
  ggplot(aes(x = stat)) +
  geom_dotplot(binwidth = 0.1, fill = "#1696d2", stroke = 0) +
  theme_minimal() +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )
```

```{r}
set.seed(557)

boot_dist_1000 <- citibike_sample_2018 |>
  specify(response = tripduration_min) |>
  generate(reps = 1000, type = "bootstrap") |>
  calculate(stat = "mean")

boot_dist_1000 |>
  ggplot(aes(x = stat)) +
  geom_dotplot(binwidth = 0.1, dotsize = .45, fill = "#1696d2", stroke = 0) +
  theme_minimal() +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )
```

```{r}
boot_ci <- boot_dist_1000 |>
  get_confidence_interval(level = 0.95, type = "percentile")

print(boot_ci)

boot_dist_1000 |>
  visualize(bins = 100, fill = "#1696d2", stroke = 0) +
  shade_confidence_interval(endpoints = boot_ci, fill = "#fdbf11", color = "#fdbf11") +
  theme_minimal() +
  xlim(10, 16) +
  labs(x = "Bootstrap Mean Trip Duration", y = "") +
  theme(axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      panel.grid.minor = element_blank()
      )
```

### Mathematical confidence interval for mean trip duration

```{r}
citibike_sample_2018 |>
  select(tripduration_min) |>
  t.test(conf.level = 0.95) |>
  tidy()
```

### Comparison of bootstrap and mathematical confidence intervals

```{r}
pop_mean <- mean(citibike_2018$tripduration_min, na.rm = TRUE)

boot_mean <- mean(boot_dist_1000$stat)

t_result <- citibike_sample_2018 |>
  select(tripduration_min) |>
  t.test(conf.level = 0.95) |>
  tidy()

tibble(
  Method = c("Population (True)", "Bootstrap", "T-test"),
  Mean = c(pop_mean, boot_mean, t_result$estimate),
  Lower_CI = c(NA, boot_ci$lower_ci, t_result$conf.low),
  Upper_CI = c(NA, boot_ci$upper_ci, t_result$conf.high)
)
```

### Bivariate analysis: Trip duration by user type

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = tripduration_min, fill = usertype)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of Trip Durations by User Type",
    x = "Trip Duration (minutes)",
    y = "Density",
    fill = "User Type"
  ) +
  xlim(0, 60) +
  theme_minimal() +
  remove_ticks()
```

```{r}
citibike_sample_2018 |>
  group_by(usertype) |>
  summarize(mean_duration = mean(tripduration_min, na.rm = TRUE)) |>
  ggplot(aes(x = usertype, y = mean_duration, fill = usertype)) +
  urbnthemes::geom_col(show.legend = FALSE) +
  labs(
    title = "Mean Trip Duration by User Type",
    x = "",
    y = "Mean Trip Duration (minutes)"
  ) +
  coord_flip() +
  theme_minimal()
```

```{r}
citibike_sample_2018 |>
  ggplot(aes(x = weekday_weekend, y = tripduration_min, fill = weekday_weekend)) +
  geom_boxplot(show.legend = FALSE, outlier.shape = NA) +
  stat_summary(
    fun = mean, 
    geom = "point", 
    shape = 23,
    size = 4, 
    fill = "#db2b27",
    color = "#000000",
    show.legend = FALSE
    ) +
  labs(
    title = "Trip Duration Distribution by Week Part",
    x = "",
    y = "Trip Duration (minutes)"
  ) +
  coord_flip(ylim = c(0, 30)) +
  theme_minimal()
```
