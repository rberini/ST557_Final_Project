---
title: "Final Project: Citi Bikes"
author: "Robert Berini"
format: html
editor: visual
execute: 
  warning: false
  message: false
---

## Introduction

The Citi Bike program is a bike-sharing system in New York City that allows users to rent bicycles for short trips around the city. The program has become increasingly popular since its launch in 2013, with millions of rides taken each year. In this project, we will analyze Citi Bike trip data for 2018 to gain insights into usage patterns, popular routes, and user profiles.

### Data Source

The data for this analysis is sourced from the Citi Bike system's public data repository, which provides monthly trip data in CSV format. The dataset includes information such as trip duration, start and end stations, user type (subscriber or customer), and timestamps for each trip.

### Data Dictionary

-   `tripduration`: Duration of the trip in seconds
-   `starttime`: Timestamp for when the trip started
-   `stoptime`: Timestamp for when the trip ended
-   `start station id`: Unique identifier for the starting station
-   `start station name`: Name of the starting station
-   `end station id`: Unique identifier for the ending station
-   `end station name`: Name of the ending station
-   `bikeid`: Unique identifier for the bike used
-   `usertype`: Type of user (Subscriber or Customer)
-   `birth year`: Birth year of the user
-   `gender`: Gender of the user

## Data Loading and Preparation

Load required packages

```{r}
library(conflicted)
library(tidyverse)
library(fs)
library(vroom)
library(janitor)
library(urbnthemes)
library(skimr)

conflicts_prefer(dplyr::filter)

options(
  scipen = 999,
  pillar.sigfig = 10
  )

set_urbn_defaults(style = "print")
```

Load the Citi Bike data for 2018

```{r}
citibike_2018_raw <-
  dir_ls("data/monthly", glob = "*.csv") |>
  vroom()

nrow(citibike_2018_raw)
head(citibike_2018_raw)
```

Clean names and column types

```{r}
citibike_2018 <- citibike_2018_raw |>
  clean_names() |>
  mutate(
    gender = factor(gender, levels = c(0, 1, 2), labels = c("Unknown", "Male", "Female")),
    usertype = factor(usertype),
    across(ends_with("id"), as.character)
  )

glimpse(citibike_2018)
```

## Create calculated variables

```{r}
citibike_2018 <- citibike_2018 |>
  mutate(
    tripduration_min = tripduration / 60,
    month = month(starttime, label = TRUE),
    day_of_week = wday(starttime, label = TRUE),
    weekday_weekend = factor(if_else(
      day_of_week %in% c("Sat", "Sun"), "Weekend", "Weekday"
    )),
    hour_of_day = hour(starttime),
    time_of_day = case_when(
      hour_of_day >= 5 & hour_of_day < 9 ~ "Morning",
      hour_of_day >= 9 & hour_of_day < 12 ~ "Late Morning",
      hour_of_day >= 12 & hour_of_day < 17 ~ "Afternoon",
      hour_of_day >= 17 & hour_of_day < 21 ~ "Evening",
      TRUE ~ "Night"
    ),
    time_of_day = factor(
      time_of_day,
      levels = c("Morning", "Late Morning", "Afternoon", "Evening", "Night"),
      ordered = TRUE
    ),
    approx_age = 2018 - birth_year,
    round_trip = if_else(start_station_id == end_station_id, TRUE, FALSE),
    usertype = fct_rev(usertype)
  )
```

## Reorder columns for easier viewing

```{r}
citibike_2018 <- citibike_2018 |>
  relocate(
    tripduration,
    tripduration_min,
    starttime,
    stoptime,
    month,
    day_of_week,
    weekday_weekend,
    hour_of_day,
    time_of_day,
    start_station_id,
    start_station_name,
    start_station_latitude,
    start_station_longitude,
    end_station_id,
    end_station_name,
    end_station_latitude,
    end_station_longitude,
    round_trip,
    bikeid,
    usertype,
    birth_year,
    approx_age,
    gender
  )
```

## Exploratory data analysis

### Summary parameters

```{r}
summary(citibike_2018)
```

```{r}
citibike_2018 |>
  skim()
```

### Trip duration density plot (excluding extreme values)

```{r}
citibike_2018 |>
  filter(tripduration_min < 2880) |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(title = "Distribution of Trip Duration", 
       x = "Duration (minutes)", 
       y = "Density")
```

### Zoom in on trip duration

```{r}
citibike_2018 |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(
    title = "Distribution of Trip Durations",
    x = "Trip Duration (minutes)",
    y = "Density"
  ) +
  xlim(0, 60)
```

### Age distribution

```{r}
ggplot(citibike_2018, aes(x = approx_age)) +
  geom_density() +
  labs(title = "Distribution of Age", 
       x = "Age (years)", 
       y = "Density")
```

```{r}
citibike_2018 |>
  ggplot(aes(x = birth_year)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Distribution of Birth Years")
```

```{r}
citibike_2018 |>
  count(birth_year, sort = TRUE) |>
  slice(1) |>
  pull(birth_year)
```

```{r}
citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  ) |>
  ggplot(aes(x = birth_year)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Distribution of Birth Years")
```

```{r}
citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  ) |>
  summary()
```

```{r}
citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  ) |>
  skim()
```

```{r}
citibike_2018 <-
  citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  )
```

## Save data and create sample

```{r}
write_csv(citibike_2018_raw, "data/combined/citibike_2018_full.csv")
write_rds(citibike_2018_raw, "data/combined/citibike_2018_full.rds")
write_csv(citibike_2018, "data/combined/citibike_2018_transformed.csv")
write_rds(citibike_2018, "data/combined/citibike_2018_transformed.rds")
```

```{r}
set.seed(557)

citibike_sample_2018 <-
  citibike_2018 |>
  slice_sample(n = 1000)
```

### Write sample to file

```{r}
write_csv(citibike_sample_2018, "data/sample/citibike_2018_sample_1000.csv")
write_rds(citibike_sample_2018, "data/sample/citibike_2018_sample_1000.rds")
```
