---
title: "Final Project: Citi Bikes"
author: "Robert Berini"
format: html
editor: visual
execute: 
  warning: false
  message: false
---

## Introduction

The Citi Bike program is a bike-sharing system in New York City that allows users to rent bicycles for short trips around the city. The program has become increasingly popular since its launch in 2013, with millions of rides taken each year. In this project, we will analyze Citi Bike trip data for 2018 to gain insights into usage patterns, popular routes, and user profiles.

The primary operational goal is to optimize bike distribution across stations to meet demand. Bike turnover time is a critical metric for this purpose, as it indicates how frequently bikes are rented and returned at each station. By analyzing trip duration, start and end locations, and user demographics, we can identify high-demand stations and times of day, allowing for better allocation and re-balancing of bikes and improved service for users. Monthly operational reports can be found at <https://citibikenyc.com/system-data/operating-reports>.

In 2018, Citi Bike offered two main rider types: **Subscribers** and **Customers**. Subscribers paid an annual membership fee of \$169 for unlimited rides up to 45 minutes each. The overage fee for subscribers was \$2.50 for each additional 15 minutes. Customers paid \$3 for a single ride of 30 minutes or less, or \$12 for a day pass including unlimited 30-minute rides within 24 hours. The overage fee for customers was \$4 for each additional 15 minutes. Understanding the differences in usage patterns between these two groups can help inform pricing strategies and service improvements.

### Data Source

The data for this analysis is sourced from the Citi Bike system's public data repository (<https://citibikenyc.com/system-data>), which provides monthly trip data in CSV format. The dataset includes information such as trip duration, start and end stations, user type (subscriber or customer), and timestamps for each trip.

### Data Dictionary

-   `tripduration`: Duration of the trip in seconds
-   `starttime`: Timestamp for when the trip started
-   `stoptime`: Timestamp for when the trip ended
-   `start station id`: Unique identifier for the starting station
-   `start station name`: Name of the starting station
-   `end station id`: Unique identifier for the ending station
-   `end station name`: Name of the ending station
-   `bikeid`: Unique identifier for the bike used
-   `usertype`: Type of user (Subscriber or Customer)
-   `birth year`: Birth year of the user
-   `gender`: Gender of the user

## Data Loading and Preparation

Load required packages

```{r}
library(conflicted) #for managing function name conflicts
library(tidyverse) #for data manipulation and visualization
library(fs) #for file system operations
library(vroom) #for fast data reading
library(janitor) #for data cleaning and nicer tables
library(urbnthemes) #for urban institute chart styles
library(skimr) #for enhanced data summaries

conflicts_prefer(dplyr::filter)

options(
  scipen = 999,
  pillar.sigfig = 10
  )

set_urbn_defaults(style = "print")
```

Load the Citi Bike data for 2018 (due to storage restrictions, monthly data files are ignored in github push, but can be found here: <https://www.dropbox.com/scl/fo/4t9lxprlwsb2qlm9mvog4/AEY1O31-BSayOjP49fLGNQc?rlkey=s6fc0yozc1bd24kej2kzk71d5&st=qdb173fh&dl=0>)

```{r}
citibike_2018_raw <-
  dir_ls("data/monthly", glob = "*.csv") |>
  vroom()

nrow(citibike_2018_raw)
head(citibike_2018_raw)
```

Clean names and column types

```{r}
citibike_2018 <- citibike_2018_raw |>
  clean_names() |>
  mutate(
    gender = factor(gender, levels = c(0, 1, 2), labels = c("Unknown", "Male", "Female")),
    usertype = factor(usertype),
    across(ends_with("id"), as.character)
  )

glimpse(citibike_2018)
```

Create calculated variables

```{r}
citibike_2018 <- citibike_2018 |>
  mutate(
    tripduration_min = tripduration / 60,
    month = month(starttime, label = TRUE),
    day_of_week = wday(starttime, label = TRUE),
    weekday_weekend = factor(if_else(
      day_of_week %in% c("Sat", "Sun"), "Weekend", "Weekday"
    )),
    hour_of_day = hour(starttime),
    time_of_day = case_when(
      hour_of_day >= 5 & hour_of_day < 9 ~ "Morning",
      hour_of_day >= 9 & hour_of_day < 12 ~ "Late Morning",
      hour_of_day >= 12 & hour_of_day < 17 ~ "Afternoon",
      hour_of_day >= 17 & hour_of_day < 21 ~ "Evening",
      TRUE ~ "Night"
    ),
    time_of_day = factor(
      time_of_day,
      levels = c("Morning", "Late Morning", "Afternoon", "Evening", "Night"),
      ordered = TRUE
    ),
    approx_age = 2018 - birth_year,
    round_trip = if_else(start_station_id == end_station_id, TRUE, FALSE),
    usertype = fct_rev(usertype)
  )
```

Reorder columns for easier viewing

```{r}
citibike_2018 <- citibike_2018 |>
  relocate(
    tripduration,
    tripduration_min,
    starttime,
    stoptime,
    month,
    day_of_week,
    weekday_weekend,
    hour_of_day,
    time_of_day,
    start_station_id,
    start_station_name,
    start_station_latitude,
    start_station_longitude,
    end_station_id,
    end_station_name,
    end_station_latitude,
    end_station_longitude,
    round_trip,
    bikeid,
    usertype,
    birth_year,
    approx_age,
    gender
  )
```

## Investigate data quality issues

Scan summary parameters

```{r}
summary(citibike_2018)
```

Dig deeper with `skimr` package

```{r}
citibike_2018 |>
  skim()
```

Summary parameters indicate some potential data quality issues to investigate further, including trip duration, birth year, and gender. Timestamps contain some missing values.

Explore trip duration distribution (excluding extreme values)

```{r}
citibike_2018 |>
  filter(tripduration_min < 2880) |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(title = "Distribution of Trip Duration", 
       x = "Duration (minutes)", 
       y = "Density")
```

Zoom in on trip duration under one hour

```{r}
citibike_2018 |>
  ggplot(aes(x = tripduration_min)) +
  geom_density() +
  labs(
    title = "Distribution of Trip Durations",
    x = "Trip Duration (minutes)",
    y = "Density"
  ) +
  xlim(0, 60)
```

Explore age distribution (excluding extreme values)

```{r}
ggplot(citibike_2018, aes(x = approx_age)) +
  geom_density() +
  labs(title = "Distribution of Age", 
       x = "Age (years)", 
       y = "Density")
```

Age has some very high, unlikely values. More concerning, there is a large spike around 50 years old, indicating potential data quality issues. Confirm the spike by examining birth year distribution.

```{r}
citibike_2018 |>
  ggplot(aes(x = birth_year)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Distribution of Birth Years")
```

Identify the value of the spike

```{r}
citibike_2018 |>
  count(birth_year, sort = TRUE) |>
  slice(1) |>
  pull(birth_year)
```

The spike occurs at birth year 1969, indicating a potential placeholder value for missing or unknown birth years or perhaps incomplete observations.

See if resolving other data quality issues alleviates the birth year spike. Here we filter out trips with missing round trip status, birth years before 1918 (age over 100), unknown gender, trip duration over 48 hours (according to Citi Bike policies, bikes are considered "lost" after 48 hours).

```{r}
citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  ) |>
  ggplot(aes(x = birth_year)) +
  geom_histogram(binwidth = 1) +
  labs(title = "Distribution of Birth Years")
```

Scan summary parameters after applying data quality filters

```{r}
citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  ) |>
  summary()
```

Confirm resolution of issues with `skimr` after applying data quality filters

```{r}
citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  ) |>
  skim()
```

Apply data quality filters to main dataset

```{r}
citibike_2018 <-
  citibike_2018 |>
  filter(
    !is.na(round_trip),
    !is.na(birth_year),
    birth_year >= 1918,
    tripduration_min <= 2880,
    gender != "Unknown"
  )
```

### Save data

Write full and transformed datasets to files (due to storage restrictions, these files are ignored in github push, but can be found here: <https://www.dropbox.com/scl/fo/ixqkr5rq1nakxo0bacp61/AIcmLoLn_SPSOD7nIHkAAug?rlkey=si1yf2etblzmywpg6pm0y6ohk&st=0jmv5zz0&dl=0>)

```{r}
write_csv(citibike_2018_raw, "data/combined/citibike_2018_full.csv")
write_rds(citibike_2018_raw, "data/combined/citibike_2018_full.rds")
write_csv(citibike_2018, "data/combined/citibike_2018_transformed.csv")
write_rds(citibike_2018, "data/combined/citibike_2018_transformed.rds")
```

## Create sample

Create a random sample of 1000 rows

```{r}
set.seed(557)

citibike_sample_2018 <-
  citibike_2018 |>
  slice_sample(n = 1000)
```

Write sample to file

```{r}
write_csv(citibike_sample_2018, "data/sample/citibike_2018_sample_1000.csv")
write_rds(citibike_sample_2018, "data/sample/citibike_2018_sample_1000.rds")
```

Continued analysis is performed in a separate notebook using the sample data for faster processing. The sample data analysis can be found at <https://rberini.github.io/ST557_Final_Project/ST557_Citi_Bikes_Sample.html>.
